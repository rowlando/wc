#!/usr/bin/env node

const fs = require('node:fs');
const parseArgs = require('./parseArgs');

// Export the core function for testing while keeping the script executable
function wc(filename, flag, callback) {
  fs.stat(filename, (err, stats) => {
    if (err) {
      callback(err);
      return;
    }

    if (flag !== '-c' && flag !== '-l' && flag !== '-w' && flag !== '-m' && flag !== null) {
      callback(null, '');
      return;
    }

    if (flag === '-c') {
      callback(null, `${stats.size} ${filename}`);
    }

    if (flag === '-l') {
      fs.readFile(filename, 'utf8', (err, data) => {
        if (err) {
          callback(err);
          return;
        }
        const lineCount = data ? data.split('\n').length : 0;
        callback(null, `${lineCount} ${filename}`);
      });
    }

    if (flag === '-w') {
      fs.readFile(filename, 'utf8', (err, data) => {
        if (err) {
          callback(err);
          return;
        }
        const wordCount = data ? data.trim().split(/\s+/).length : 0;
        callback(null, `${wordCount} ${filename}`);
      });
    }

    if (flag === '-m') {
      fs.readFile(filename, 'utf8', (err, data) => {
        if (err) {
          callback(err);
          return;
        }
        const charCount = data ? data.length : 0;
        callback(null, `${charCount} ${filename}`);
      });
    }

    if (flag === null) {
      fs.readFile(filename, 'utf8', (err, data) => {
        if (err) {
          callback(err);
          return;
        }
        const byteCount = stats.size;
        const lineCount = data ? data.split('\n').length : 0;
        const wordCount = data ? data.trim().split(/\s+/).length : 0;
        callback(null, `${byteCount} ${lineCount} ${wordCount} ${filename}`);
      });
    }

  });
}

// Only run this part when file is executed directly, not when imported
if (require.main === module) {
  const { flag, filename } = parseArgs(process.argv);

  wc(filename, flag, (err, result) => {
    if (err) {
      console.error(err);
      return;
    }
    if (result) {
      console.log(result);
    }
  });
}

// This export will only be used by the test file
module.exports = wc;
